#! /usr/bin/groovy

def AGENT_LABEL = 'mr-0xc10'
def DOCKER_IMAGE = 'docker.h2o.ai/opsh2oai/mr-h2o3-runtime:latest'
def DOCKER_ARGS = '-v /home/0xdiag/smalldata:/home/0xdiag/smalldata -v /home/0xdiag/bigdata:/home/0xdiag/bigdata -e HOME=\${WORKSPACE}'

def make_target(def target) {
  sh """
    export JAVA_HOME=/usr/lib/jvm/java-${params.javaVersion}-oracle
    export USER=jenkins
    . /envs/h2o_env_python${params.pythonVersion}/bin/activate
    activate_R_${params.rVersion}
    cd h2o-3
    ln -s -f /home/0xdiag/smalldata
    ln -s -f /home/0xdiag/bigdata
    make -f Makefile.jenkins ${target}
  """
}

pipeline {

    agent none

    parameters {
      string(name: 'gitBranch', defaultValue: 'mr/feature/h2o3-runtime-docker', description: 'Branch to load the Dockerfile from.')
      choice(name: 'rVersion', description: 'R version to use', choices: '3.4.1\n3.3.3\n3.2.5\n3.1.3\n3.0.3')
      choice(name: 'pythonVersion', description: 'Python version to use', choices: '3.5\n2.7')
      choice(name: 'javaVersion', description: 'Java version to use', choices: '8')
    }

    environment {
        H2O_GIT_URL = 'https://github.com/h2oai/h2o-3.git'
    }

    options {
        ansiColor('xterm')
        timestamps()
        timeout(time: 2, unit: 'HOURS')
    }

    stages {
        stage ('Checkout Sources') {
            agent { label AGENT_LABEL }

            steps {
              sh "printenv"
              dir('h2o-3') {
                git url: env.H2O_GIT_URL, branch: params.gitBranch
                sh """
                  rm -f smalldata
                  rm -f bigdata
                """
              }
            }
        }

        stage ('Build H2O-3') {
          agent {
            docker {
              label AGENT_LABEL
              image DOCKER_IMAGE
              args DOCKER_ARGS
              reuseNode true
            }
          }
          steps {
            script {
              make_target('build-h2o-3')
            }
          }
        }

        stage ('Test PhantomJS') {
          agent {
            docker {
              label AGENT_LABEL
              image DOCKER_IMAGE
              args DOCKER_ARGS
              reuseNode true
            }
          }
          steps {
            script {
              make_target('test-phantomjs')
            }
          }
        }

        stage ('Test PhantomJS Medium') {
          agent {
            docker {
              label AGENT_LABEL
              image DOCKER_IMAGE
              args DOCKER_ARGS
              reuseNode true
            }
          }
          steps {
            script {
              make_target('test-phantomjs-medium')
            }
          }
        }

        stage ('Test PhantomJS Small') {
          agent {
            docker {
              label AGENT_LABEL
              image DOCKER_IMAGE
              args DOCKER_ARGS
              reuseNode true
            }
          }
          steps {
            script {
              make_target('test-phantomjs-small')
            }
          }
        }
    }

    // post {
    //     failure {
    //         emailext (
    //               subject: "FAILED: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]'",
    //               body: """<p>FAILED: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]':</p>
    //                 <p>Check console output at "<a href="${env.BUILD_URL}">${env.JOB_NAME} [${env.BUILD_NUMBER}]</a>"</p>""",
    //               to: "michalr@h2o.ai"
    //         )
    //     }
    // }
}
